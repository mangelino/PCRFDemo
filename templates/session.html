{% extends "base.html" %}
{% block title %}Session{% endblock %}
{% block head %}
{{ super() }}

<script type="text/javascript">
	var intervalId;
	var consChart;
	var bwChart;
	var consDps = [];
	var bwDps = []; // dataPoints
	var consumed = 0;
	var tempConsumed = 0;
	var MAXSTOP = 999999999;
	var AVGBW = 500;
	var THROTTLE = 999999999;	

	

	window.onload = function() {
		consChart = new CanvasJS.Chart("consumption",{
			title :{
				text: "Data consumption"
			},			
			data: [{
				type: "line",
				dataPoints: consDps 
			}]
		});

		bwChart = new CanvasJS.Chart("bandwidth",{
			title :{
				text: "Bandwidth"
			},			
			data: [{
				type: "line",
				dataPoints: bwDps 
			}]
		});
	}

	var xVal = 0;
	var yVal;
	var stopX = MAXSTOP;	
	var averageBw = 200;
	var updateInterval = 20;
	var dataLength = 500; // number of dataPoints visible at any point

	function updateChart (count, bw) {
		count = count || 1;
		// count is number of times loop runs to generate random dataPoints.
		var delta= Math.round(bw/5 + Math.random() *(-bw));
		

		for (var j = 0; j < count; j++) {	
			yVal = bw +  delta;
			//if (consumed > 500000) {
				if (yVal > THROTTLE) {
					yVal = THROTTLE;

				}
			// 	if (stopX == MAXSTOP) {
			// 		stopX = xVal;
			// 	}
			// }
			if (yVal<0) {
					yVal = 0;
				}
			bwDps.push({
				x: xVal,
				y: yVal
			});

			consumed = consumed + yVal;
			tempConsumed = tempConsumed + yVal;
			consDps.push({
				x: xVal,
				y: consumed
			});

			xVal++;
			if (xVal-stopX > dataLength) {
				clearInterval(intervalId);
			}
		};
		if (bwDps.length > dataLength)
		{
			bwDps.shift();				
		}

		if (consDps.length > dataLength)
		{
			consDps.shift();				
		}
		consChart.render();
		bwChart.render();

		if (tempConsumed > 4100) {
			submitFormPredefined("Data",tempConsumed);
			tempConsumed = 0;
		}
	};
	

	function start() {
		stopX = MAXSTOP;
		$("#usageWell").hide();
		if (intervalId)
			clearInterval(intervalId); 

		// generates first set of dataPoints
		updateChart(dataLength,0); 
		//consumed = 0;

		// update chart after specified time. 
		intervalId = setInterval(function(){updateChart(1, AVGBW);}, updateInterval); 
	}

	function stop() {
		// update chart after specified time. 
		clearInterval(intervalId); 
		$("#usageWell").show();
	}

	function pause() {
		if (intervalId) {
			clearInterval(intervalId);
			intervalId = null;
		} else {
			intervalId = setInterval(function(){updateChart(1, AVGBW);}, updateInterval);
		}
		
	}

	function submitFormPredefined(elem_id, bytes)
	{
		document.getElementById(elem_id).value = bytes; 
		var postData = $("#sessionForm").serializeArray();
    	var formURL = $("#sessionForm").attr("altaction");
		$.ajax(
			    {
			        url : formURL,
			        type: "POST",
			        data : postData,
			        success:function(data, textStatus, jqXHR) 
			        {
			        	var jsondata = JSON.parse(data);
			            //alert(data);//data: return data from server
			            bucketRows = "";
			            for (var j = 0; j < jsondata.buckets.length; j++) {
			            	//$("#bucket_"+jsondata.buckets[j].id).html(getReadableFileSizeString(jsondata.buckets[j].counters.tot));
			            	bucketRows += generateBucketRow(jsondata.buckets[j]);

			            }
			            $("#bucketsTable tbody").html(bucketRows);
			            for (var minfo in jsondata.session.monitoringInfo) {
			            	$("#mkey_"+minfo).html(getReadableFileSizeString(jsondata.session.monitoringInfo[minfo][3]));

			            }
			            var rules = jsondata.session.rules;
			            rulesHtml = "";
			            THROTTLE = 999999999;
			            for (var j=0; j<rules.length; j++) {
			            	THROTTLE = Math.min(jsondata.pcef.rules[rules[j]][5], THROTTLE);
			            	rulesHtml += '<span class="label label-primary">'+rules[j]+'</span>'
			            }
			            $("#rules").html(rulesHtml);

			        },
			        error: function(jqXHR, textStatus, errorThrown) 
			        {
			            //if fails      
			        }
			    });
		//document.getElementById(elem_id).value = bytes; 
		//document.getElementById('sessionForm').submit();
	}

	function generateBucketRow(bucket)
	{
		c = "";
		if (checkValidity(bucket.stopTime)) {
			c += '<tr>\n';
			c += "<td>"+bucket.id+"</td>";
			c += "<td>"+bucket.name+"</td>";
			c += "<td>"+bucket.startTime+"</td>";
			c += "<td>"+bucket.stopTime+"</td>";
			c += "<td>"+getReadableFileSizeString(bucket.counters.tot)+"</td>";
			c += "</tr>";
		}
		return c;
	}

	function checkValidity(time)
	{
		var now = new Date();
		if (Date.parse(time)<now.setSeconds(now.getSeconds()-60)) {
			return false;
		} else {
			return true;
		}
	}

	function getReadableFileSizeString(fileSizeInBytes) {

	    var i = -1;
	    var byteUnits = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
	    do {
	        fileSizeInBytes = fileSizeInBytes / 1024;
	        i++;
	    } while (fileSizeInBytes > 1024);

	    return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
	};
	</script>
	<script type="text/javascript" src="/assets/script/canvasjs.min.js"></script>
{% endblock %}
{% block content %}

  
<div class="container">	      
	<div class="row">
		<div class="row">
			<button onclick="start();" value="Start" class="btn btn-sm btn-default">Start</button>
			<button onclick="stop();" value="Stop" class="btn btn-sm btn-default">Stop</button>
			<button onclick="pause();" value="Pause" class="btn btn-sm btn-default">Pause/Play</button>
		</div>
		<div class="row" style="padding: 20px;">
			<div class="col-md-4" id="consumption" style="height: 200px;">
			</div>
			<div class="col-md-4 col-md-offset-2" id="bandwidth" style="height: 200px;">
		</div>
		</div>
	</div>
	


<!-- <div>
<button class="btn btn-sm btn-default" onclick='$("#vid1").play()'>Play</button>
	 <video id="vid1" width="640" height="360" controls>
       <source src="/assets/video/big_buck_bunny_1080p_h264.mov"/> 
       Your browser does not support the video tag.
   </video>
</div> -->
<form id="sessionForm" action="/pcef/{{pcef.id}}/sessions/{{session.sessionId}}" altaction="/pcef/{{pcef.id}}/sessions/json/{{session.sessionId}}" method="post"> 
	<div id="usageWell" class="row well">
		<div class="col-md-10">
			<table class="table table-condensed">
				<thead>
					<tr>	
						<th class="col-sm-1">Traffic type</th>
						<th class="col-sm-1">Used</th> 
						<th class="col-sm-1">Granted</th>
						<th class="col-sm-1">New usage</th>
						<th class="col-sm-2">Usage</th>
					</tr>
				</thead>
				<tbody>
					{% for minfo in session.monitoringInfo.values() %}				
						<tr>	
							<td> {{ minfo.key}} </td>
							<td> {{ minfo.usage|filesizeformat}} </td>
							<td><span id="mkey_{{minfo.key}}"> {{ minfo.gsu|filesizeformat}} </span></td> 
							<td><input id="{{minfo.key}}" type="text" name="{{minfo.key}}"></td>
							<td><img src="/assets/images/twitter.png" width="20px" height="20px" onclick='submitFormPredefined("{{minfo.key}}", 140);'>
							<img src="/assets/images/facebook.png" width="20px" height="20px" onclick='submitFormPredefined("{{minfo.key}}", 2000);'>
							<img src="/assets/images/youtube.png" width="20px" height="20px" onclick='submitFormPredefined("{{minfo.key}}", 300000);'>
							<img src="/assets/images/netflix.jpeg" width="20px" height="20px" onclick='submitFormPredefined("{{minfo.key}}", 1000000);'></td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<div class="col-md-2">
			<input type="submit" class="btn btn-success" value="Report usage">		
		</div>
	</div>


	
	<div class="row">
		<div class="col-md-8">
		<h3>Buckets</h3>
			<div id="demo" class="collapse in">
				<table id="bucketsTable" class="table">  
					<tr>
						<th>ID</th>
						<th>Product</th>
						<th>StartTime</th>
						<th>StopTime</th>
						<th>Counters</th>
					</tr>
					{% for bucket in buckets %}
					{% if bucket.stopTime == None or unicodeToDatetime(bucket.stopTime) > date_now() %}
					<tr>
						<td>{{bucket.id}}</td>
						<td>{{bucket.name}}</td>
						<td>{{bucket.startTime}}</td>
						<td>{{bucket.stopTime}}</td>
						<td><span id="bucket_{{bucket.id}}">		
						{{bucket.counters["tot"]|filesizeformat}}</span>
							<!--
							<table class="table">  
							{% for k,v in bucket.counters.iteritems() %}
							<tr>
									<td align="left">{{k}}</td><td align="right">{{v}}</td>
							</tr>
							{% endfor %}
							</table>
							-->
			
						</td>
					</tr>
					{% endif %}
					{% endfor %}
				</table>
			</div>
		</div>
  	
  	<div class="col-md-4">
	<h3>Session</h3>     
		<table class="table">   
			<tr>
				<td>Rules</td>
				<td>
					<h4 id="rules">
					{% for chargingRule in session.installedRules %}
					<a href="/pcef/rule/{{chargingRule}}">
					<span class="label label-primary">{{chargingRule}}</span></a>
					{% endfor %}
					</h4>
				</td>
			</tr> 
			<!-- <tr>
				<td>Session Id</td><td> {{session.sessionId}} </td>
			</tr> -->
			<tr>	
				<td>UE Identity</td><td><a href="/ue/{{session.identity}}"> {{session.identity}} </a></td> 
			</tr>
			<tr>
				<td>Location</td>
				<td>
					<label class="radio-inline">
					<input type="radio" name="isAtHome" id="isAtHome_False" value="0" {% if not session.atHomeLocation %} checked {% endif %}> <span class="glyphicon glyphicon-tree-deciduous"></span>
					</label>
					<label class="radio-inline">
					  <input type="radio" name="isAtHome" id="isAtHome_True" value="1" {% if session.atHomeLocation %} checked {% endif %}> <span class="glyphicon glyphicon-home"></span>
					</label>
				</td>
			</tr>
			
		</table>
	</div>
	</div>

</form>
	
	<div style="padding-top:20px;">
	<form action="/pcef/{{pcef.id}}/sessions/delete/{{session.sessionId}}" method="POST">
	<input type="submit" class="btn btn-danger" value="Switch-off terminal">
	</form>
	</div>



{% endblock %}